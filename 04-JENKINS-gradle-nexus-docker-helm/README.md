# CICD
## Tutorial Ref
```
https://www.youtube.com/watch?v=adG0vq5boL8
https://github.com/raghib1992/cheatsheet
```
## Tools used in our CICD pipeline

- Jenkins 
- github
- sonar (using docker)
- nexus registry
- kubernetes
- helm

## 5 instance are required
1. Jenkins => (docker, kubectl, helm, datree.io, git)
2. Kube-master
3. kube-worker
4. nexus
5. sonar


### Install Docker
```
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo systemctl status docker
```

### Install Helm
```
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
```

### Install Kubectl
Ref https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-using-native-package-management

## Install unzip on jenkins server

## Install Datree
Download Datree Helm plugin
```
helm plugin install https://github.com/datreeio/helm-datree
```

#### Test files
##### By default, test files generated by Helm will be skipped. If you wish to include test files in your policy check, add the --include-tests flag:
```
helm datree test --include-tests [CHART_DIRECTORY]
```


***************************************
### Jenkins Plugins 
1. Sonarqube Scanner
2. Sonar Gerrit
3. Sonarqube Generic COverage
4. Sonar Quality Gates
### For using
```
agent {
  docker {
    image 'jdk-11'
  }
}
```
5. Docker
6. Docker Pipeline
7. docker-build-step


### Configure - 
*https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/*
1. From Sonar side - Create token
- Adminostration - security - user- generate token
2. From Jenkins side
- Credential- Secret Text
- COnfigure tool- SonarQube Server


### Git checkout 
*https://github.com/raghib1992/CICD_Java_gradle_application.git*


### Sonar code Analysis
- To Generate Pipeline systax
```
withSonarQubeEnv('sonarqube-server') {
  sh 'gradle sonarqube'
}
```


### Sonar quality feedback
1. Create webhook in sonarqube
- Administration - configuration - webhook - add /sonarqube-webhook/ with jenkins url 
2. In Jenkins
- add timout in pipleine sonar analysis stage
```
def qg = waitForQualityGate() // Reuse taskId previously collected by withSonarQubeEnv
if (qg.status != 'OK') {
    error "Pipeline aborted due to quality gate failure: ${qg.status}"
}
```

### roubleshooting
*https://issues.jenkins.io/browse/JENKINS-58432*

### Nexus
1. Create Repo in Nexus for push docker image
realm - docker bearer token
2. In Jenkins check for any default repo register
```
docker info
```

3. Add Nexus Repo
create file /etc/docker/daemon.json 
```
{ "insecure-registries":["nexus_machine_ip:8083"] }
```
restrt docker
```
systemctl restart docker
```
```
docker info
```
once this is done from jenkins host you can try 
```
docker login -u nexus_username -p nexus_pass nexus_ip:8083
docker login -u admin -p admin123 43.205.228.101:8083
```

### Create Dockerfile
```
FROM 

****************
Configure mail server
1. plugin
Mail extension plugin
2. COnfigure Jenkins
smtp = smtp.gmail.com
smtp port = 465
username = email
password = 
use ssl
3. gmail 
disble security
***********************
datree stage for helm chart analysis

install plugin

helm plugin install https://github.com/datreeio/helm-datree

stage ('Helm chart config analysis by datree'){
            steps{
                script {
                    dir('kubernetes') {
                        withEnv(['DATREE_TOKEN=f892607c-2509-40a6-b42b-c82442379f74']) {
                            sh 'helm datree test myapp/'
                        }
                    }
                }
            }    
        }
        *****************

        push helm chart to repo
create helm-hosted repo on nexus
stage ('Docker Build and Docker Push') {
            steps {
                script{
                    withCredentials([string(credentialsId: 'docker-repo', variable: 'repo_credential')]) {
                        dir('kubernetes') {
                            sh '''
                            helmversion=$(helm show chart myapp | grep version | cut -d: -f2 | tr -d ' ')
                            tar -czvf myapp-0.2.0.tgz myapp/                         
                            curl -u admin:$repo_credential http://172.31.37.20:8081/repository/helm-repo/ --upload-file myapp-${helmversion}.tgz -v
                        '''
                        }
                        
                    }
                }
            }
        }

        *****************
deploy helm on kuberenetes server

plugin 
kubernetes cont deploy plugin

Manage credential
kubernetes configurtion
ID 
